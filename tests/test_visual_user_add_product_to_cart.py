# Импорт Page Object страницы логина.
# Тесты работают ТОЛЬКО с Page Object'ами,
# они не знают о Selenium, локаторах и ожиданиях.
from pages.login_page import LoginPage


def test_visual_user_add_product_to_cart(driver):
    """
    Тестовый сценарий:
    1. Открыть страницу логина Swag Labs.
    2. Залогиниться пользователем visual_user.
    3. При необходимости закрыть попап смены пароля
       (попап может появляться не всегда).
    4. Считать название и цену первого товара в каталоге.
    5. Добавить этот товар в корзину.
    6. Перейти на страницу корзины.
    7. Считать название и цену товара в корзине.
    8. Сравнить данные товара в корзине с данными из каталога.

    Важно:
    - driver передаётся в тест через pytest fixture
    - тест НЕ управляет ожиданиями и НЕ содержит Selenium-деталей
    - вся работа с UI инкапсулирована в Page Object'ах
    """

    # ===== ШАГ 1. ОТКРЫТИЕ СТРАНИЦЫ ЛОГИНА =====
    # Создаём Page Object страницы логина и открываем базовый URL
    login = LoginPage(driver).open()

    # ===== ШАГ 2. АВТОРИЗАЦИЯ =====
    # Выполняем логин пользователем visual_user.
    # После успешного логина возвращается InventoryPage
    inventory = login.login("visual_user", "secret_sauce")

    # ===== ШАГ 3. ОБРАБОТКА НЕОБЯЗАТЕЛЬНОГО ПОПАПА =====
    # Попап смены пароля может появляться нестабильно.
    # Метод закрывает его, если он есть, и ничего не делает,
    # если попап отсутствует.
    inventory.close_password_leak_popup_if_present()

    # ===== ШАГ 4. ЧТЕНИЕ ДАННЫХ ТОВАРА ИЗ КАТАЛОГА =====
    # Получаем название и цену первого товара в каталоге.
    # Метод только читает данные и не меняет состояние страницы.
    title, price = inventory.get_product_1_info()

    # ===== ШАГ 5–6. ДОБАВЛЕНИЕ ТОВАРА В КОРЗИНУ И ПЕРЕХОД =====
    # add_product_1_to_cart():
    # - кликает кнопку "Add to cart"
    # - остаётся на странице каталога
    #
    # open_cart():
    # - кликает по иконке корзины
    # - выполняет переход на страницу корзины
    cart = inventory.add_product_1_to_cart().open_cart()

    # ===== ШАГ 7. ЧТЕНИЕ ДАННЫХ ИЗ КОРЗИНЫ =====
    # Считываем название и цену товара, добавленного в корзину.
    cart_title, cart_price = cart.get_cart_product_1_info()

    # ===== ШАГ 8. ПРОВЕРКИ (ASSERTIONS) =====
    # Проверяем, что данные товара в корзине
    # совпадают с данными товара из каталога.
    assert cart_title == title, \
        f"Title mismatch. Catalog='{title}', Cart='{cart_title}'"
    assert cart_price == price, \
        f"Price mismatch. Catalog='{price}', Cart='{cart_price}'"